<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI-Powered GrapesJS Builder</title>
    <script src="[https://unpkg.com/@grapesjs/studio-sdk/dist/index.umd.js](https://unpkg.com/@grapesjs/studio-sdk/dist/index.umd.js)"></script>
    <link rel="stylesheet" href="[https://unpkg.com/@grapesjs/studio-sdk/dist/style.css](https://unpkg.com/@grapesjs/studio-sdk/dist/style.css)" />

    <style>
        :root {
            --ai-pane-width: 350px;
            --bg-dark: #121212;
            --bg-panel: #1e1e1e;
            --accent: #9c27b0;
            --text-main: #e0e0e0;
            --border: #333;
        }

        body, html { margin: 0; padding: 0; height: 100%; overflow: hidden; font-family: 'Inter', sans-serif; background: var(--bg-dark); color: var(--text-main); }

        /* MAIN LAYOUT */
        .app-layout { display: flex; height: 100vh; width: 100vw; transition: all 0.3s ease; }

        /* LEFT: AI SIDEBAR */
        .ai-sidebar {
            width: var(--ai-pane-width);
            background: var(--bg-panel);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            position: relative;
            transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 10;
        }

        /* Collapsed State */
        .ai-sidebar.collapsed { width: 0; border: none; overflow: hidden; }
        .ai-sidebar.collapsed .ai-content { opacity: 0; pointer-events: none; }

        /* TOGGLE BUTTON */
        .toggle-btn {
            position: absolute;
            right: -40px; /* Push outside the sidebar */
            top: 15px;
            width: 40px;
            height: 40px;
            background: var(--bg-panel);
            border: 1px solid var(--border);
            border-left: none;
            border-radius: 0 8px 8px 0;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-main);
            z-index: 20;
            box-shadow: 2px 2px 10px rgba(0,0,0,0.2);
        }
        .toggle-btn:hover { color: var(--accent); }

        /* AI CONTENT */
        .ai-content { display: flex; flex-direction: column; height: 100%; opacity: 1; transition: opacity 0.2s; min-width: var(--ai-pane-width); }
        
        .ai-header { padding: 15px; border-bottom: 1px solid var(--border); font-weight: 600; display: flex; align-items: center; gap: 10px; background: #252525; }
        .status-led { width: 8px; height: 8px; background: #666; border-radius: 50%; box-shadow: 0 0 5px rgba(0,0,0,0.5); transition: background 0.3s; }
        .status-led.thinking { background: #00e676; animation: pulse 1s infinite; }
        
        .chat-history { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 15px; scroll-behavior: smooth; }
        
        /* MESSAGES */
        .msg { padding: 12px; border-radius: 6px; font-size: 0.9rem; line-height: 1.5; max-width: 95%; word-wrap: break-word; }
        .msg.bot { background: #2d2d2d; border: 1px solid #333; align-self: flex-start; }
        .msg.user { background: rgba(156, 39, 176, 0.2); border: 1px solid var(--accent); align-self: flex-end; color: #f3e5f5; }
        .msg code { font-family: monospace; background: rgba(0,0,0,0.3); padding: 2px 4px; border-radius: 3px; }

        /* INPUT AREA */
        .input-area { padding: 15px; border-top: 1px solid var(--border); background: #252525; display: flex; flex-direction: column; gap: 10px; }
        .input-box {
            width: 100%; box-sizing: border-box; padding: 12px; background: #1a1a1a; border: 1px solid #444; color: white; border-radius: 6px; resize: none; font-family: inherit; height: 80px;
        }
        .input-box:focus { outline: none; border-color: var(--accent); }
        
        .action-row { display: flex; justify-content: space-between; align-items: center; }
        .model-badge { font-size: 0.75rem; color: #888; background: #333; padding: 4px 8px; border-radius: 4px; }
        
        .send-btn {
            background: var(--accent); color: white; border: none; padding: 8px 20px; border-radius: 4px; font-weight: 600; cursor: pointer; transition: background 0.2s;
        }
        .send-btn:hover { background: #7b1fa2; }
        .send-btn:disabled { background: #444; cursor: not-allowed; }

        /* RIGHT: EDITOR */
        .editor-wrapper { flex: 1; position: relative; height: 100%; overflow: hidden; }

        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.4; } 100% { opacity: 1; } }
    </style>
</head>
<body>

    <div class="app-layout">
        <div class="ai-sidebar" id="ai-sidebar">
            
            <div class="toggle-btn" onclick="toggleSidebar()">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M15 18l-6-6 6-6" id="toggle-icon"/>
                </svg>
            </div>

            <div class="ai-content">
                <div class="ai-header">
                    <div class="status-led" id="ai-status"></div>
                    <span>AI Designer</span>
                </div>

                <div class="chat-history" id="chat-history">
                    <div class="msg bot">
                        Hello! Describe the layout you want. I'll generate clean, layer-named HTML for you.
                    </div>
                </div>

                <div class="input-area">
                    <textarea class="input-box" id="user-input" placeholder="E.g., Create a 3-column pricing table with dark theme..."></textarea>
                    <div class="action-row">
                        <span class="model-badge">Model: Google Gemini Flash 2.0</span>
                        <button class="send-btn" id="send-btn">Generate</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="editor-wrapper">
            <div id="studio-editor" style="height: 100%"></div>
        </div>
    </div>

    <script>
        // ==========================================
        // CONFIGURATION
        // ==========================================
        const CONFIG = {
            // ⚠️ REPLACE WITH YOUR KEY OR USE A BROWSER EXTENSION TO INJECT
            apiKey: 'OPENROUTER_API_KEY', 
            siteUrl: window.location.href, // Required by OpenRouter
            appName: 'GrapesJS AI Builder',
            // Cheapest / Free model
            model: 'google/gemini-2.0-flash-lite-preview-02-05:free' 
        };

        // Global Editor Reference
        let studioEditor = null;

        // ==========================================
        // 1. GRAPESJS INITIALIZATION
        // ==========================================
        GrapesJsStudioSDK.createStudioEditor({
            root: '#studio-editor',
            licenseKey: 'e50c20f9bbf746e4a85e7bd9ebf0faa601ba3461f1864001a90319272a846cbf',
            theme: 'dark',
            project: { type: 'web' },
            assets: { storageType: 'self' },
            onReady: (editor) => {
                studioEditor = editor;
                console.log('✅ Editor Ready');
            }
        });

        // ==========================================
        // 2. AI SERVICE & STREAMING LOGIC
        // ==========================================
        class AIService {
            constructor() {
                this.history = [];
                this.systemPrompt = `
                    You are an expert web developer for GrapesJS.
                    1. Output ONLY valid HTML code. 
                    2. DO NOT include <html>, <head>, or <body> tags. 
                    3. Start directly with <section>, <div>, or <header>.
                    4. IMPORTANT: Add 'data-gjs-name="Layer Name"' to major elements so they show up named in the Layers panel (e.g., <div data-gjs-name="Hero Text">).
                    5. Use modern CSS (Flexbox/Grid) inside <style> tags if needed, or inline styles.
                    6. Do not output Markdown backticks (\`\`\`). Just raw code.
                `;
            }

            async generateCode(userPrompt, onChunk, onComplete) {
                // Prepare messages
                const messages = [
                    { role: 'system', content: this.systemPrompt },
                    ...this.history,
                    { role: 'user', content: userPrompt }
                ];

                try {
                    const response = await fetch("[https://openrouter.ai/api/v1/chat/completions](https://openrouter.ai/api/v1/chat/completions)", {
                        method: "POST",
                        headers: {
                            "Authorization": `Bearer ${CONFIG.apiKey}`,
                            "HTTP-Referer": CONFIG.siteUrl,
                            "X-Title": CONFIG.appName,
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({
                            model: CONFIG.model,
                            messages: messages,
                            stream: true // ENABLE STREAMING
                        })
                    });

                    if (!response.ok) throw new Error(`API Error: ${response.status}`);

                    const reader = response.body.getReader();
                    const decoder = new TextDecoder("utf-8");
                    let fullText = "";

                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;

                        const chunk = decoder.decode(value, { stream: true });
                        const lines = chunk.split("\n");

                        for (const line of lines) {
                            if (line.trim().startsWith("data: ")) {
                                const jsonStr = line.replace("data: ", "").trim();
                                if (jsonStr === "[DONE]") break;

                                try {
                                    const json = JSON.parse(jsonStr);
                                    const content = json.choices[0]?.delta?.content || "";
                                    
                                    if (content) {
                                        fullText += content;
                                        onChunk(content); // Update UI
                                    }
                                } catch (e) { /* Ignore parsing errors for partial chunks */ }
                            }
                        }
                    }

                    this.history.push({ role: 'user', content: userPrompt });
                    this.history.push({ role: 'assistant', content: fullText });
                    
                    onComplete(fullText);

                } catch (error) {
                    console.error("AI Error:", error);
                    onChunk(`\n[Error: ${error.message}]`);
                }
            }
        }

        // ==========================================
        // 3. UI CONTROLLER
        // ==========================================
        const aiService = new AIService();
        const chatHistory = document.getElementById('chat-history');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const statusLed = document.getElementById('ai-status');

        function addMessage(text, type) {
            const div = document.createElement('div');
            div.className = `msg ${type}`;
            // Simple prevention of HTML rendering in chat for safety
            div.innerText = text; 
            chatHistory.appendChild(div);
            chatHistory.scrollTop = chatHistory.scrollHeight;
            return div;
        }

        sendBtn.onclick = async () => {
            const text = userInput.value.trim();
            if (!text) return;

            // UI Updates
            addMessage(text, 'user');
            userInput.value = '';
            statusLed.classList.add('thinking');
            sendBtn.disabled = true;

            // Create a placeholder for the BOT response
            const botMsgDiv = addMessage("", 'bot');
            let accumulatedResponse = "";

            await aiService.generateCode(text, 
                // 1. On Chunk (Streaming to Chat UI)
                (chunk) => {
                    accumulatedResponse += chunk;
                    botMsgDiv.innerText = accumulatedResponse; // Update chat text live
                    chatHistory.scrollTop = chatHistory.scrollHeight;
                },
                // 2. On Complete (Update Editor)
                (fullCode) => {
                    statusLed.classList.remove('thinking');
                    sendBtn.disabled = false;
                    
                    // Clean the code (Remove ```html wrapper if present)
                    let cleanCode = fullCode.replace(/```html/g, '').replace(/```/g, '').trim();

                    console.log("Injecting Code:", cleanCode);
                    uploadHtmlContent(cleanCode);
                }
            );
        };

        // ==========================================
        // 4. EDITOR INJECTION (The "Function")
        // ==========================================
        function uploadHtmlContent(htmlContent) {
            if (!studioEditor) {
                alert("Editor not ready yet.");
                return;
            }

            // SAFETY: Ensure we don't break the JSON structure
            // We use setComponents to REPLACE the project content as requested
            try {
                // If it contains a style tag, GrapesJS handles it, but let's be safe
                studioEditor.setComponents(htmlContent);
                console.log("Project updated successfully");
            } catch (err) {
                console.error("GrapesJS Injection Error:", err);
                alert("Failed to render the AI code. Check console.");
            }
        }

        // ==========================================
        // 5. SIDEBAR TOGGLE LOGIC
        // ==========================================
        function toggleSidebar() {
            const sidebar = document.getElementById('ai-sidebar');
            const icon = document.getElementById('toggle-icon');
            
            sidebar.classList.toggle('collapsed');

            // Change Icon direction
            if (sidebar.classList.contains('collapsed')) {
                icon.setAttribute('d', 'M9 18l6-6-6-6'); // Arrow Right
            } else {
                icon.setAttribute('d', 'M15 18l-6-6 6-6'); // Arrow Left
            }
        }

        // Allow Enter key to send (Shift+Enter for new line)
        userInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendBtn.click();
            }
        });

    </script>
</body>
</html>
