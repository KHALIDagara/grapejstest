<% content_for :title, "Page Builder" %>

<% content_for :head do %>
  <!-- GrapesJS CSS -->
  <link rel="stylesheet" href="https://unpkg.com/grapesjs/dist/css/grapes.min.css">
  <style>
    /* Editor takes full viewport */
    .editor-container {
      display: flex;
      height: 100vh;
      width: 100vw;
    }

    /* Main editor area */
    #gjs {
      flex: 1;
      border: none;
    }

    /* Sidebar panel */
    .sidebar-panel {
      width: 320px;
      background: #1e293b;
      border-left: 1px solid #334155;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* Tab navigation */
    .sidebar-tabs {
      display: flex;
      border-bottom: 1px solid #334155;
    }

    .sidebar-tab {
      flex: 1;
      padding: 12px;
      text-align: center;
      cursor: pointer;
      color: #94a3b8;
      border-bottom: 2px solid transparent;
      transition: all 0.2s;
    }

    .sidebar-tab:hover {
      color: #fff;
      background: #334155;
    }

    .sidebar-tab.active {
      color: #3b82f6;
      border-bottom-color: #3b82f6;
    }

    /* Tab content */
    .tab-content {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    /* Chat messages */
    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .chat-message {
      padding: 10px 12px;
      border-radius: 8px;
      max-width: 90%;
    }

    .chat-message.user {
      background: #3b82f6;
      align-self: flex-end;
    }

    .chat-message.assistant {
      background: #334155;
      align-self: flex-start;
    }

    /* Chat input */
    .chat-input-container {
      padding: 12px;
      border-top: 1px solid #334155;
    }

    .chat-input {
      width: 100%;
      padding: 10px 12px;
      background: #1e293b;
      border: 1px solid #334155;
      border-radius: 8px;
      color: #fff;
      resize: none;
    }

    .chat-input:focus {
      outline: none;
      border-color: #3b82f6;
    }

    /* Pages list */
    .pages-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .page-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 12px;
      background: #334155;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .page-item:hover {
      background: #475569;
    }

    .page-item.active {
      background: #3b82f6;
    }

    /* Theme settings */
    .theme-control {
      margin-bottom: 16px;
    }

    .theme-control label {
      display: block;
      margin-bottom: 6px;
      font-size: 14px;
      color: #94a3b8;
    }

    .theme-control input[type="color"] {
      width: 100%;
      height: 40px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }

    .theme-control input[type="text"],
    .theme-control select {
      width: 100%;
      padding: 8px 12px;
      background: #334155;
      border: 1px solid #475569;
      border-radius: 8px;
      color: #fff;
    }

    /* GrapesJS dark theme overrides */
    .gjs-one-bg { background-color: #1e293b; }
    .gjs-two-color { color: #94a3b8; }
    .gjs-three-bg { background-color: #334155; }
    .gjs-four-color, .gjs-four-color-h:hover { color: #3b82f6; }
  </style>
<% end %>

<div class="editor-container"
     data-controller="editor sidebar chat"
     data-editor-page-id-value="<%= @current_page.id %>"
     data-editor-store-url-value="<%= store_page_path(@current_page) %>"
     data-editor-load-url-value="<%= load_page_path(@current_page) %>"
     data-editor-pages-value="<%= @pages.map { |p| { id: p.id, name: p.name } }.to_json %>"
     data-chat-url-value="<%= page_ai_chat_path(@current_page) %>">

  <!-- GrapesJS Editor -->
  <div id="gjs"></div>

  <!-- Sidebar Panel -->
  <div class="sidebar-panel">
    <!-- Tabs -->
    <div class="sidebar-tabs">
      <button class="sidebar-tab active" data-action="click->sidebar#switchTab" data-tab="chat">
        Chat
      </button>
      <button class="sidebar-tab" data-action="click->sidebar#switchTab" data-tab="pages">
        Pages
      </button>
      <button class="sidebar-tab" data-action="click->sidebar#switchTab" data-tab="theme">
        Theme
      </button>
    </div>

    <!-- Chat Tab -->
    <div id="tab-chat" class="tab-content active" data-sidebar-target="tabContent">
      <div class="chat-messages" data-chat-target="messages">
        <% (@current_page.messages || []).each do |msg| %>
          <div class="chat-message <%= msg['role'] %>">
            <%= msg['content'] %>
          </div>
        <% end %>
      </div>
      <div class="chat-input-container">
        <div class="mb-2 text-xs text-slate-500" data-chat-target="context">
          No element selected
        </div>
        <textarea
          class="chat-input"
          rows="3"
          placeholder="Describe what you want to change..."
          data-chat-target="input"
          data-action="keydown->chat#handleKeydown"></textarea>
        <button
          class="w-full mt-2 bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-lg transition-colors"
          data-action="click->chat#send">
          Send
        </button>
      </div>
    </div>

    <!-- Pages Tab -->
    <div id="tab-pages" class="tab-content" data-sidebar-target="tabContent">
      <div class="mb-4">
        <button
          class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-lg transition-colors"
          data-action="click->editor#createPage">
          + New Page
        </button>
      </div>
      <div class="pages-list" data-editor-target="pagesList">
        <% @pages.each do |page| %>
          <div class="page-item <%= 'active' if page == @current_page %>"
               data-action="click->editor#selectPage"
               data-page-id="<%= page.id %>">
            <span><%= page.name %></span>
            <% unless page == @current_page %>
              <button class="text-red-400 hover:text-red-300 text-sm"
                      data-action="click->editor#deletePage"
                      data-page-id="<%= page.id %>">
                Delete
              </button>
            <% end %>
          </div>
        <% end %>
      </div>
    </div>

    <!-- Theme Tab -->
    <div id="tab-theme" class="tab-content" data-sidebar-target="tabContent">
      <div class="theme-control">
        <label>Primary Color</label>
        <input type="color"
               value="<%= @current_page.theme_with_defaults['primaryColor'] %>"
               data-action="change->editor#updateTheme"
               data-theme-key="primaryColor">
      </div>
      <div class="theme-control">
        <label>Secondary Color</label>
        <input type="color"
               value="<%= @current_page.theme_with_defaults['secondaryColor'] %>"
               data-action="change->editor#updateTheme"
               data-theme-key="secondaryColor">
      </div>
      <div class="theme-control">
        <label>Font Family</label>
        <select data-action="change->editor#updateTheme" data-theme-key="fontFamily">
          <option value="Inter, sans-serif" <%= 'selected' if @current_page.theme_with_defaults['fontFamily'] == 'Inter, sans-serif' %>>Inter</option>
          <option value="Arial, sans-serif" <%= 'selected' if @current_page.theme_with_defaults['fontFamily'] == 'Arial, sans-serif' %>>Arial</option>
          <option value="Georgia, serif" <%= 'selected' if @current_page.theme_with_defaults['fontFamily'] == 'Georgia, serif' %>>Georgia</option>
          <option value="monospace" <%= 'selected' if @current_page.theme_with_defaults['fontFamily'] == 'monospace' %>>Monospace</option>
        </select>
      </div>
      <div class="theme-control">
        <label>Border Radius</label>
        <input type="text"
               value="<%= @current_page.theme_with_defaults['borderRadius'] %>"
               placeholder="8px"
               data-action="change->editor#updateTheme"
               data-theme-key="borderRadius">
      </div>
    </div>

    <!-- User Info -->
    <div class="p-4 border-t border-slate-700 text-sm text-slate-400">
      <div class="flex items-center justify-between">
        <span><%= current_user.email %></span>
        <%= button_to "Sign Out", logout_path, method: :delete,
            class: "text-red-400 hover:text-red-300" %>
      </div>
    </div>
  </div>
</div>

<!-- GrapesJS Script -->
<script src="https://unpkg.com/grapesjs"></script>
<script src="https://unpkg.com/grapesjs-blocks-basic"></script>
